<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>HPL-Lens</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1620;
      --panel-2:#111b28;
      --muted:#8aa0b5;
      --text:#eef5ff;
      --accent:#6bd6ff;
      --accent-2:#8b9bff;
      --ok:#7CFFB2;
      --warn:#ffd37c;
      --danger:#ff7c7c;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(107,214,255,.08), transparent 60%),
        radial-gradient(1200px 600px at 90% 0%, rgba(139,155,255,.08), transparent 60%),
        var(--bg);
      min-height:100vh;
    }
    header{
      padding:22px 26px 10px;
      display:flex;
      align-items:center;
      gap:14px;
    }
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.18), var(--shadow);
    }
    .title h1{
      font-size:22px;margin:0 0 2px 0;letter-spacing:.2px;
    }
    .title small{color:var(--muted)}
    .topbar{
      padding: 0 26px 18px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .tabs{
      background: var(--panel);
      border:1px solid rgba(255,255,255,.06);
      padding:4px;
      border-radius: 12px;
      display:flex;
      gap:4px;
      box-shadow: var(--shadow);
    }
    .tab-btn{
      border:0;
      color:var(--text);
      background: transparent;
      padding:8px 12px;
      border-radius: 9px;
      cursor:pointer;
      font-weight:600;
      opacity:.75;
    }
    .tab-btn.active{
      background: linear-gradient(135deg, rgba(107,214,255,.14), rgba(139,155,255,.14));
      opacity:1;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    }
    .status-pill{
      display:flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius: 10px;
      background: var(--panel);
      border:1px solid rgba(255,255,255,.06);
      color: var(--muted);
      font-size:12px;
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background: #666;
    }
    .dot.ok{background: var(--ok)}
    .dot.warn{background: var(--warn)}
    .dot.danger{background: var(--danger)}

    .container{padding: 0 26px 30px;}

    /* Browse controls */
    .controls{
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      padding: 14px;
      display:grid;
      grid-template-columns: 1.2fr .7fr .7fr .6fr auto;
      gap: 10px;
      align-items:center;
      box-shadow: var(--shadow);
    }
    @media (max-width: 1100px){
      .controls{grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 640px){
      .controls{grid-template-columns: 1fr; }
    }
    .input, select{
      width:100%;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      color: var(--text);
      padding: 10px 11px;
      border-radius: 10px;
      outline:none;
    }
    .input::placeholder{color: rgba(238,245,255,.45)}
    .btn{
      border:0;
      background: linear-gradient(135deg, rgba(107,214,255,.18), rgba(139,155,255,.18));
      color: var(--text);
      padding: 10px 12px;
      border-radius: 10px;
      cursor:pointer;
      font-weight:600;
      border:1px solid rgba(255,255,255,.08);
    }
    .btn.secondary{
      background: rgba(255,255,255,.04);
    }

    .meta{
      display:flex;gap:12px;align-items:center;
      padding: 10px 2px 0;
      color: var(--muted);
      font-size: 12px;
    }

    /* Grid cards */
    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 14px;
    }
    @media (max-width: 1200px){ .grid{grid-template-columns: repeat(3,1fr);} }
    @media (max-width: 900px){ .grid{grid-template-columns: repeat(2,1fr);} }
    @media (max-width: 520px){ .grid{grid-template-columns: 1fr;} }

    .card{
      background: linear-gradient(180deg, var(--panel), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
      display:flex;flex-direction:column;
      min-height: 240px;
    }
    .thumb{
      background: rgba(255,255,255,.03);
      aspect-ratio: 16/10;
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
    }
    .thumb img{
      width:100%;height:100%;object-fit: cover;
      display:block;
      transform: scale(1.01);
    }
    .card-body{
      padding: 12px 12px 14px;
      display:flex;flex-direction:column;gap:6px;
    }
    .code{
      font-weight:800; letter-spacing:.3px;
      font-size: 14.5px;
    }
    .name{
      font-size: 13.5px;
      color: rgba(238,245,255,.9);
      font-weight: 600;
    }
    .tags{
      margin-top:auto;
      display:flex;justify-content: space-between;gap:8px;
      color: var(--muted);
      font-size: 11px;
    }

    /* Scan panel */
    .scan-panel{
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 900px){
      .scan-panel{grid-template-columns: 1fr;}
    }
    .scan-left, .scan-right{
      background: rgba(255,255,255,.02);
      border:1px dashed rgba(255,255,255,.08);
      border-radius: 12px;
      padding: 14px;
      min-height: 260px;
    }
    .scan-left img{
      width:100%;
      max-height: 360px;
      object-fit: contain;
      border-radius: 10px;
      background: rgba(255,255,255,.03);
    }
    .scan-actions{
      display:flex;gap:8px;flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .result-box{
      margin-top: 10px;
      padding: 12px;
      border-radius: 10px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.06);
    }
    .result-ok{border-color: rgba(124,255,178,.35)}
    .result-warn{border-color: rgba(255,211,124,.35)}
    .result-title{font-weight:800}
    .small{color:var(--muted);font-size: 12px}
  </style>
</head>
<body>
  <header>
    <div class="logo"></div>
    <div class="title">
      <h1>HPL-Lens</h1>
      <small>Browse + Scan (prototype) terhubung Firestore</small>
    </div>
  </header>

  <div class="topbar">
    <div class="tabs">
      <button class="tab-btn active" data-tab="browse">Browse</button>
      <button class="tab-btn" data-tab="scan">Scan</button>
    </div>

    <div class="status-pill">
      <span id="dbDot" class="dot warn"></span>
      <span id="dbText">Menunggu koneksi Firestore...</span>
      <span id="lastSync"></span>
    </div>
  </div>

  <div class="container">

    <!-- ================= BROWSE ================= -->
    <section id="tab-browse">
      <div class="controls">
        <input id="q" class="input" placeholder="Cari code / nama..." />
        <select id="brandFilter"></select>
        <select id="catFilter"></select>
        <select id="sortBy">
          <option value="code-asc">Sort: Code A-Z</option>
          <option value="code-desc">Sort: Code Z-A</option>
          <option value="name-asc">Sort: Name A-Z</option>
          <option value="name-desc">Sort: Name Z-A</option>
        </select>
        <div style="display:flex;gap:8px">
          <button id="refreshBtn" class="btn">Refresh</button>
          <button id="clearBtn" class="btn secondary">Clear</button>
        </div>
      </div>
      <div class="meta">
        <span id="countText">0 data</span>
        <span>•</span>
        <span id="cacheText">cache: -</span>
      </div>
      <div id="grid" class="grid"></div>
    </section>

    <!-- ================= SCAN ================= -->
    <section id="tab-scan" style="display:none">
      <div class="scan-panel">
        <div class="scan-left">
          <div class="scan-actions">
            <input id="scanFile" class="input" type="file" accept="image/*" />
            <button id="scanBtn" class="btn">Scan</button>
            <button id="scanClearBtn" class="btn secondary">Clear</button>
          </div>
          <img id="scanPreview" alt="Preview scan" />
          <div class="small" style="margin-top:8px">
            Upload foto motif dari file kamu. Nama file bebas.
          </div>
        </div>

        <div class="scan-right">
          <div class="result-box" id="resultBox">
            <div class="result-title">Hasil Scan</div>
            <div class="small">
              Matching pakai <b>imageHash</b> yang kamu isi di Firestore.
            </div>
          </div>

          <div class="result-box" style="margin-top:12px">
            <div class="result-title">Catatan</div>
            <ul class="small">
              <li>Pastikan setiap dokumen motifs punya <b>imageHash</b> (bukan "pending").</li>
              <li>Threshold default dibuat aman biar hasil gak ngasal.</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

  </div>

  <!-- ================= FIREBASE + APP ================= -->
  <script type="module">
    // ===============================
    // 1) GANTI CONFIG INI
    // ===============================
    const firebaseConfig = {
      apiKey: "AIzaSyDFNme3BVEC7ILnDDJxQjp44aY_PDv2SKk",
      authDomain: "hpl-lens.firebaseapp.com",
      projectId: "hpl-lens",
      storageBucket: "hpl-lens.firebasestorage.app",
      messagingSenderId: "120830142",
      appId: "1:120830142:web:bd03a0248596f3ade3c6ef",
    };

    // Firebase CDN (modular)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ===============================
    // UI refs
    // ===============================
    const tabButtons = document.querySelectorAll(".tab-btn");
    const tabBrowse = document.getElementById("tab-browse");
    const tabScan = document.getElementById("tab-scan");

    const dbDot = document.getElementById("dbDot");
    const dbText = document.getElementById("dbText");
    const lastSync = document.getElementById("lastSync");

    const q = document.getElementById("q");
    const brandFilter = document.getElementById("brandFilter");
    const catFilter = document.getElementById("catFilter");
    const sortBy = document.getElementById("sortBy");
    const refreshBtn = document.getElementById("refreshBtn");
    const clearBtn = document.getElementById("clearBtn");
    const countText = document.getElementById("countText");
    const cacheText = document.getElementById("cacheText");
    const grid = document.getElementById("grid");

    const scanFile = document.getElementById("scanFile");
    const scanBtn = document.getElementById("scanBtn");
    const scanClearBtn = document.getElementById("scanClearBtn");
    const scanPreview = document.getElementById("scanPreview");
    const resultBox = document.getElementById("resultBox");

    // ===============================
    // Tabs
    // ===============================
    tabButtons.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        tabButtons.forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const t = btn.dataset.tab;
        tabBrowse.style.display = t==="browse" ? "" : "none";
        tabScan.style.display = t==="scan" ? "" : "none";
      });
    });

    // ===============================
    // Firestore init
    // ===============================
    let app, db;
    try{
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
    }catch(err){
      setDbStatus("danger", "Firebase config belum diisi / salah.");
      console.error(err);
    }

    function setDbStatus(type, text){
      dbDot.className = "dot " + type;
      dbText.textContent = text;
    }

    // ===============================
    // Data state + cache
    // ===============================
    let motifs = [];

    const CACHE_KEY = "HPL_LENS_MOTIFS_CACHE_V1";
    const CACHE_TTL_MS = 1000 * 60 * 10; // 10 menit

    function saveCache(data){
      localStorage.setItem(CACHE_KEY, JSON.stringify({
        ts: Date.now(),
        data
      }));
    }

    function loadCache(){
      try{
        const raw = localStorage.getItem(CACHE_KEY);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(Date.now() - obj.ts > CACHE_TTL_MS) return null;
        return obj;
      }catch{
        return null;
      }
    }

    // ===============================
    // Fetch motifs
    // ===============================
    async function fetchMotifs({force=false} = {}){
      if(!db) return;

      setDbStatus("warn", "Mengambil data motifs...");
      lastSync.textContent = "";

      if(!force){
        const cached = loadCache();
        if(cached?.data){
          motifs = cached.data;
          cacheText.textContent = "cache: ON";
          renderFilters();
          renderGrid();
          setDbStatus("ok", "Data dari cache.");
          lastSync.textContent = "• cached";
        }
      }

      try{
        const snap = await getDocs(collection(db, "motifs"));
        motifs = snap.docs.map(d => ({ id: d.id, ...d.data() }));

        saveCache(motifs);
        cacheText.textContent = "cache: ON";

        renderFilters();
        renderGrid();

        setDbStatus("ok", "Firestore tersambung.");
        const now = new Date();
        lastSync.textContent = "• synced " + now.toLocaleTimeString();
      }catch(err){
        console.error(err);
        setDbStatus("danger", "Gagal ambil data. Cek rules / config.");
      }
    }

    // ===============================
    // Filters
    // ===============================
    function uniq(arr){
      return [...new Set(arr.filter(Boolean))].sort((a,b)=>a.localeCompare(b));
    }

    function renderFilters(){
      const brands = uniq(motifs.map(m=>m.brand));
      const cats = uniq(motifs.map(m=>m.category));

      brandFilter.innerHTML = `<option value="">All Brand</option>` +
        brands.map(b=>`<option value="${escapeHtml(b)}">${escapeHtml(b)}</option>`).join("");

      catFilter.innerHTML = `<option value="">All Category</option>` +
        cats.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
    }

    // ===============================
    // Render grid
    // ===============================
    function renderGrid(){
      const keyword = (q.value || "").trim().toLowerCase();
      const bf = brandFilter.value;
      const cf = catFilter.value;
      const sb = sortBy.value;

      let filtered = motifs.slice();

      if(keyword){
        filtered = filtered.filter(m =>
          (m.code || "").toLowerCase().includes(keyword) ||
          (m.name || "").toLowerCase().includes(keyword)
        );
      }
      if(bf) filtered = filtered.filter(m => (m.brand || "") === bf);
      if(cf) filtered = filtered.filter(m => (m.category || "") === cf);

      filtered.sort((a,b)=>{
        const ac = (a.code || ""), bc = (b.code || "");
        const an = (a.name || ""), bn = (b.name || "");
        switch(sb){
          case "code-desc": return bc.localeCompare(ac);
          case "name-asc": return an.localeCompare(bn);
          case "name-desc": return bn.localeCompare(an);
          default: return ac.localeCompare(bc);
        }
      });

      countText.textContent = `${filtered.length} data ditemukan dari ${motifs.length} total`;

      grid.innerHTML = filtered.map(m => cardTpl(m)).join("") ||
        `<div class="small" style="padding:10px;color:var(--muted)">Belum ada data di collection motifs.</div>`;
    }

    function cardTpl(m){
      const img = m.imageUrl || "";
      return `
        <div class="card">
          <div class="thumb">
            ${img ? `<img loading="lazy" src="${escapeAttr(img)}" alt="${escapeAttr(m.code||"motif")}" />`
                 : `<div class="small">No image</div>`}
          </div>
          <div class="card-body">
            <div class="code">${escapeHtml(m.code || "-")}</div>
            <div class="name">${escapeHtml(m.name || "-")}</div>
            <div class="tags">
              <span>${escapeHtml(m.brand || "")}</span>
              <span>${escapeHtml(m.category || "")}</span>
            </div>
          </div>
        </div>
      `;
    }

    // ===============================
    // Scan: dHash + matching
    // ===============================
    function dHashFromImageElement(img){
      const w = 9, h = 8;
      const c = document.createElement("canvas");
      c.width = w; c.height = h;
      const ctx = c.getContext("2d", { willReadFrequently:true });
      ctx.drawImage(img, 0, 0, w, h);

      const data = ctx.getImageData(0,0,w,h).data;
      const gray = [];
      for(let y=0;y<h;y++){
        for(let x=0;x<w;x++){
          const i = (y*w + x)*4;
          const r=data[i], g=data[i+1], b=data[i+2];
          gray.push(0.299*r + 0.587*g + 0.114*b);
        }
      }

      let bits = "";
      for(let y=0;y<h;y++){
        for(let x=0;x<w-1;x++){
          const left = gray[y*w + x];
          const right = gray[y*w + x + 1];
          bits += (left > right) ? "1" : "0";
        }
      }

      let hex = "";
      for(let i=0;i<bits.length;i+=4){
        hex += parseInt(bits.substr(i,4), 2).toString(16);
      }
      return hex;
    }

    function dHashFromFile(file){
      return new Promise((resolve,reject)=>{
        const img = new Image();
        img.onload = ()=> {
          try{ resolve(dHashFromImageElement(img)); }
          catch(e){ reject(e); }
        };
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
      });
    }

    function hammingHex(a,b){
      if(!a || !b || a.length !== b.length) return 9999;
      let dist = 0;
      for(let i=0;i<a.length;i++){
        const x = parseInt(a[i],16) ^ parseInt(b[i],16);
        dist += x.toString(2).split("1").length - 1;
      }
      return dist;
    }

    function setResult(html, type=""){
      resultBox.className = "result-box " + (type ? `result-${type}` : "");
      resultBox.innerHTML = html;
    }

    async function runScan(){
      const file = scanFile.files?.[0];
      if(!file){
        setResult(`<div class="result-title">Hasil Scan</div><div class="small">Pilih file dulu.</div>`, "warn");
        return;
      }

      if(!motifs.length){
        setResult(`<div class="result-title">Hasil Scan</div><div class="small">Data motifs belum kebaca. Klik Refresh.</div>`, "warn");
        return;
      }

      // preview
      const previewUrl = URL.createObjectURL(file);
      scanPreview.src = previewUrl;

      setResult(`<div class="result-title">Hasil Scan</div><div class="small">Menghitung hash & mencari motif...</div>`);

      const queryHash = await dHashFromFile(file);

      const candidates = motifs
        .filter(m => m.imageHash && m.imageHash !== "pending")
        .map(m => ({
          ...m,
          dist: hammingHex(queryHash, m.imageHash)
        }))
        .sort((a,b)=>a.dist-b.dist);

      const best = candidates[0];

      const THRESHOLD = 8; // aman untuk prototype
      if(!best || best.dist > THRESHOLD){
        setResult(`
          <div class="result-title">Hasil Scan</div>
          <div class="small">Hash file: <b>${queryHash}</b></div>
          <div style="margin-top:6px">Motif belum dikenali.</div>
          <div class="small">Coba tambah dataset / pastikan imageHash sudah diisi.</div>
        `, "warn");
        return;
      }

      // tampilkan code + name di bawah foto (sesuai request kamu)
      setResult(`
        <div class="result-title">Motif Terdeteksi</div>
        <div style="margin-top:8px">
          <div><b>${escapeHtml(best.code || "-")}</b></div>
          <div>${escapeHtml(best.name || "-")}</div>
          <div class="small">${escapeHtml(best.brand || "")}${best.category ? " • " + escapeHtml(best.category) : ""}</div>
          <div class="small" style="margin-top:6px">distance: ${best.dist} • hash: ${queryHash}</div>
        </div>
      `, "ok");
    }

    // ===============================
    // Helpers
    // ===============================
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(str){ return escapeHtml(str); }

    // ===============================
    // Events
    // ===============================
    q.addEventListener("input", renderGrid);
    brandFilter.addEventListener("change", renderGrid);
    catFilter.addEventListener("change", renderGrid);
    sortBy.addEventListener("change", renderGrid);

    refreshBtn.addEventListener("click", ()=>fetchMotifs({force:true}));
    clearBtn.addEventListener("click", ()=>{
      q.value = "";
      brandFilter.value = "";
      catFilter.value = "";
      sortBy.value = "code-asc";
      renderGrid();
    });

    scanBtn.addEventListener("click", runScan);
    scanFile.addEventListener("change", ()=>{
      // auto preview tanpa scan dulu
      const f = scanFile.files?.[0];
      if(!f) return;
      scanPreview.src = URL.createObjectURL(f);
      setResult(`<div class="result-title">Hasil Scan</div><div class="small">Klik Scan untuk matching.</div>`);
    });
    scanClearBtn.addEventListener("click", ()=>{
      scanFile.value = "";
      scanPreview.removeAttribute("src");
      setResult(`<div class="result-title">Hasil Scan</div><div class="small">Matching pakai imageHash yang kamu isi di Firestore.</div>`);
    });

    // ===============================
    // Start
    // ===============================
    cacheText.textContent = "cache: OFF";
    await fetchMotifs({force:false});
  </script>
</body>
</html>

